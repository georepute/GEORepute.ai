"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import Image from "next/image";
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { useLanguage } from "@/lib/language-context";
import { 
  Target,
  ArrowRight,
  ArrowLeft,
  ChevronDown,
  LayoutGrid,
  Settings,
  Play,
  Plus,
  Search,
  TrendingUp,
  Eye,
  BarChart3,
  Globe,
  RefreshCw,
  Download,
  FileText,
  Activity,
  MessageSquare,
  Check,
  X,
  StopCircle,
  Trash2,
  MoreVertical,
  Send,
  Pencil
} from "lucide-react";
import {
  PieChart,
  Pie,
  Cell,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  LineChart,
  Line
} from 'recharts';

type ViewMode = 'projects' | 'form' | 'details';

interface Project {
  id: string;
  brand_name: string;
  industry: string;
  website_url?: string;
  active_platforms?: string[];
  competitors?: string[];
  keywords?: string[];
  last_analysis_at?: string;
  created_at: string;
  company_description?: string;
  company_image_url?: string;
  gsc_enabled?: boolean;
  gsc_keywords_count?: number;
  last_gsc_sync?: string;
}

interface Session {
  id: string;
  project_id: string;
  status: 'running' | 'completed' | 'failed' | 'cancelled';
  completed_queries?: number;
  total_queries?: number;
  results_summary?: any;
  session_name?: string;
  started_at: string;
}

export default function AIVisibility() {
  const { isRtl, t } = useLanguage();
  const supabase = createClientComponentClient();
  const router = useRouter();
  
  // View mode: 'projects' (list), 'form' (new analysis), 'details' (project details)
  const [viewMode, setViewMode] = useState<ViewMode>('projects');
  const [selectedProject, setSelectedProject] = useState<Project | null>(null);
  const [projects, setProjects] = useState<Project[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Form state
  const [currentStep, setCurrentStep] = useState(1);
  const totalSteps = 4;
  const [brandName, setBrandName] = useState("");
  const [websiteUrl, setWebsiteUrl] = useState("");
  const [industry, setIndustry] = useState("Marketing");
  const [competitors, setCompetitors] = useState<string[]>([]);
  const [keywords, setKeywords] = useState<string[]>([]);
  const [newCompetitor, setNewCompetitor] = useState("");
  const [newKeyword, setNewKeyword] = useState("");
  const [selectedPlatforms, setSelectedPlatforms] = useState<string[]>(["perplexity", "chatgpt"]);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [isGeneratingAI, setIsGeneratingAI] = useState(false);
  const [hasAutoGeneratedAI, setHasAutoGeneratedAI] = useState(false);
  const [fetchGSCKeywords, setFetchGSCKeywords] = useState(false);

  // Project details state
  const [projectSessions, setProjectSessions] = useState<Session[]>([]);
  const [projectStats, setProjectStats] = useState<any>(null);
  const [projectResponses, setProjectResponses] = useState<any[]>([]);
  const [activeTab, setActiveTab] = useState('summary');
  const [resultsView, setResultsView] = useState<'mentioned' | 'missed'>('mentioned');
  const [showCompletionNotification, setShowCompletionNotification] = useState(false);
  const [showAnalysisStartNotification, setShowAnalysisStartNotification] = useState(false);
  const [showAnalysisStartModal, setShowAnalysisStartModal] = useState(false);
  const [analysisStartInfo, setAnalysisStartInfo] = useState<any>(null);
  const [stoppingAnalysis, setStoppingAnalysis] = useState<string | null>(null);
  const [openDropdown, setOpenDropdown] = useState<string | null>(null);
  const [deletingProject, setDeletingProject] = useState<string | null>(null);
  const [viewResponseModal, setViewResponseModal] = useState<{ open: boolean; response: any; prompt: string } | null>(null);

  const industries = [
    "Marketing", "Technology", "Healthcare", "Finance", "Education",
    "Retail", "Real Estate", "Legal", "Consulting", "Manufacturing",
    "Food & Beverage", "Travel & Hospitality", "Entertainment",
    "Sports & Fitness", "Non-Profit", "Other"
  ];

  const platformOptions = [
    { id: "perplexity", name: "Perplexity", icon: "/images/perplexity.png" },
    { id: "chatgpt", name: "ChatGPT", icon: "/images/chatgpt.png" },
    { id: "gemini", name: "Gemini", icon: "/images/gemini 1.png", iconClass: "object-contain brightness-110 contrast-110" },
    { id: "claude", name: "Claude", icon: "/images/claude.png" },
    { id: "groq", name: "Grok", icon: "/images/groq.png" },
  ];

  // Fetch projects on mount
  useEffect(() => {
    if (viewMode === 'projects') {
      fetchProjects();
    }
  }, [viewMode]);

  // Poll for running sessions
  useEffect(() => {
    if (viewMode === 'projects' || viewMode === 'details') {
      const runningProjects = projects.filter(p => {
        const session = projectSessions.find(s => s.project_id === p.id);
        return session?.status === 'running';
      });

      if (runningProjects.length > 0) {
        const interval = setInterval(() => {
          fetchProjects();
          if (selectedProject) {
            fetchProjectDetails(selectedProject.id);
          }
        }, 5000);
        return () => clearInterval(interval);
      }
    }
  }, [viewMode, projects, projectSessions, selectedProject]);

  // Fetch responses when switching to results tab
  useEffect(() => {
    if (viewMode === 'details' && selectedProject && activeTab === 'results') {
      const latestCompleted = projectSessions.find(s => s.project_id === selectedProject.id && s.status === 'completed');
      if (latestCompleted?.id) {
        console.log('Results tab active, fetching responses for session:', latestCompleted.id);
        fetchProjectResponses(latestCompleted.id);
      } else {
        // Try latest session if no completed session
        const latestSession = projectSessions.find(s => s.project_id === selectedProject.id);
        if (latestSession?.id) {
          console.log('Results tab active, fetching responses for latest session:', latestSession.id);
          fetchProjectResponses(latestSession.id);
        }
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedProject?.id, activeTab, projectSessions.length, viewMode]);

  // Debug: Log modal state changes
  useEffect(() => {
    if (viewResponseModal) {
      console.log('Modal state changed:', viewResponseModal);
    }
  }, [viewResponseModal]);

  const fetchProjects = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data, error } = await supabase
        .from('brand_analysis_projects')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (error) throw error;
      setProjects(data || []);

      // Fetch latest session for each project
      if (data && data.length > 0) {
        const projectIds = data.map(p => p.id);
        const { data: sessions } = await supabase
          .from('brand_analysis_sessions')
          .select('*')
          .in('project_id', projectIds)
          .order('started_at', { ascending: false });

        // Group sessions by project and get latest
        const latestSessions = projectIds.map(projectId => {
          const projectSessions = (sessions || []).filter(s => s.project_id === projectId);
          return projectSessions[0] || null;
        }).filter(Boolean);

        setProjectSessions(latestSessions as Session[]);
      }
    } catch (error) {
      console.error('Error fetching projects:', error);
    } finally {
      setLoading(false);
    }
  };

  const fetchProjectDetails = async (projectId: string) => {
    try {
      // Fetch project
      const { data: project, error: projectError } = await supabase
        .from('brand_analysis_projects')
        .select('*')
        .eq('id', projectId)
        .single();

      if (projectError) throw projectError;
      setSelectedProject(project);

      // Fetch sessions
      const { data: sessions, error: sessionsError } = await supabase
        .from('brand_analysis_sessions')
        .select('*')
        .eq('project_id', projectId)
        .order('started_at', { ascending: false })
        .limit(10);

      if (sessionsError) throw sessionsError;
      setProjectSessions(sessions || []);

      // Calculate stats from latest completed session
      const latestCompleted = sessions?.find(s => s.status === 'completed');
      const wasRunning = projectSessions.find(s => s.project_id === projectId && s.status === 'running');
      
      if (latestCompleted) {
        // Set stats if available
        if (latestCompleted.results_summary) {
          setProjectStats(latestCompleted.results_summary);
        } else {
          setProjectStats(null);
        }
        
        // Show notification if analysis just completed
        if (wasRunning && latestCompleted.status === 'completed') {
          setShowCompletionNotification(true);
          setTimeout(() => setShowCompletionNotification(false), 5000);
        }
        
        // Always fetch responses for the latest completed session
        if (latestCompleted.id) {
          console.log('Fetching responses for completed session:', latestCompleted.id);
          await fetchProjectResponses(latestCompleted.id);
        }
      } else {
        // If no completed session, try to fetch from latest session (even if running)
        const latestSession = sessions?.[0];
        if (latestSession?.id) {
          console.log('No completed session, fetching from latest session:', latestSession.id);
          await fetchProjectResponses(latestSession.id);
        }
        setProjectStats(null);
      }
    } catch (error) {
      console.error('Error fetching project details:', error);
    }
  };

  const fetchProjectResponses = async (sessionId: string) => {
    try {
      console.log('Fetching responses from ai_platform_responses table for session:', sessionId);
      const { data: responses, error } = await supabase
        .from('ai_platform_responses')
        .select('*')
        .eq('session_id', sessionId)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Supabase error fetching responses:', error);
        throw error;
      }
      
      console.log('Fetched responses:', responses?.length || 0, 'responses');
      if (responses && responses.length > 0) {
        console.log('Sample response:', {
          id: responses[0].id,
          platform: responses[0].platform,
          prompt: responses[0].prompt?.substring(0, 50),
          hasResponse: !!responses[0].response,
          hasMetadata: !!responses[0].response_metadata
        });
      }
      
      setProjectResponses(responses || []);
    } catch (error) {
      console.error('Error fetching responses:', error);
      setProjectResponses([]);
    }
  };

  const getProjectSession = (projectId: string): Session | null => {
    return projectSessions.find(s => s.project_id === projectId) || null;
  };

  const getProjectStats = (projectId: string) => {
    const session = getProjectSession(projectId);
    if (!session || session.status !== 'completed') {
      return { mentions: 0, visibility: 0, sentiment: 0 };
    }
    const summary = session.results_summary || {};
    const totalQueries = summary.total_queries || 0;
    const mentions = summary.total_mentions || 0;
    const visibility = totalQueries > 0 ? (mentions / totalQueries) * 100 : 0;
    return {
      mentions,
      visibility: Math.round(visibility),
      sentiment: summary.avg_sentiment || 0
    };
  };

  const handleDeleteProject = async (projectId: string, projectName: string) => {
    if (!confirm(`Are you sure you want to delete the analysis for "${projectName}"? This action cannot be undone.`)) {
      return;
    }

    setDeletingProject(projectId);
    setOpenDropdown(null);

    try {
      // Delete the project (cascade will delete related sessions and responses)
      const { error } = await supabase
        .from('brand_analysis_projects')
        .delete()
        .eq('id', projectId);

      if (error) throw error;

      // Refresh projects list
      await fetchProjects();
      
      // If the deleted project was selected, go back to projects view
      if (selectedProject?.id === projectId) {
        setViewMode('projects');
        setSelectedProject(null);
      }
    } catch (error: any) {
      console.error('Error deleting project:', error);
      alert(`Failed to delete project: ${error.message}`);
    } finally {
      setDeletingProject(null);
    }
  };

  const handleAnalyze = async () => {
      if (!brandName.trim() || !websiteUrl.trim() || !industry) {
        alert("Please fill in all required fields");
        return;
      }

    if (selectedPlatforms.length === 0) {
      alert("Please select at least one AI platform");
      return;
    }

    setIsAnalyzing(true);

    try {
      // Step 1: Crawl website to get description and image
      console.log('Crawling website...');
      const crawlResponse = await fetch("/api/crawl-website", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url: websiteUrl }),
      });

      const crawlData = await crawlResponse.json();
      let companyDescription = '';
      let companyImageUrl = '';

      if (crawlResponse.ok && crawlData.success) {
        companyDescription = crawlData.description || '';
        companyImageUrl = crawlData.imageUrl || '';
        console.log('Website crawled successfully:', { description: companyDescription.substring(0, 50), imageUrl: companyImageUrl });
      } else {
        console.warn('Website crawl failed, continuing without description/image:', crawlData.error);
      }

      // Step 2: Create/update project with crawled data (with optional GSC)
      const response = await fetch("/api/ai-visibility", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          brandName,
          websiteUrl,
          industry,
          keywords,
          competitors,
          platforms: selectedPlatforms,
          companyDescription,
          companyImageUrl,
          fetchGSCKeywords, // Include GSC checkbox state
        }),
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || "Failed to create project");
      }

      // Refresh projects and switch to projects view
      await fetchProjects();
      setViewMode('projects');
      
    // Reset form
    setCurrentStep(1);
    setBrandName("");
    setWebsiteUrl("");
    setIndustry("Marketing");
    setCompetitors([]);
    setKeywords([]);
    setSelectedPlatforms(["perplexity", "chatgpt"]);
    setHasAutoGeneratedAI(false);
    setFetchGSCKeywords(false);
    } catch (error: any) {
      alert(`Error: ${error.message}`);
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleRunAnalysis = async (project: Project) => {
    if (!project.active_platforms || project.active_platforms.length === 0) {
      alert("Please configure at least one AI platform for this project");
      return;
    }

    setIsAnalyzing(true);

    try {
      // Get Supabase URL and session
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        throw new Error("You must be logged in to run analysis");
      }

      const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || '';
      const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || '';

      // Call the brand-analysis edge function
      const response = await fetch(`${supabaseUrl}/functions/v1/brand-analysis`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${supabaseAnonKey}`,
        },
        body: JSON.stringify({
          projectId: project.id,
          platforms: project.active_platforms,
        }),
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || "Analysis failed to start");
      }

      // Store analysis info and show modal
      setAnalysisStartInfo(data);
      setShowAnalysisStartModal(true);

      // Show notification banner
      setShowAnalysisStartNotification(true);
      setTimeout(() => setShowAnalysisStartNotification(false), 5000);

      // Refresh projects to show updated status
      await fetchProjects();
      
      // If this project is selected, refresh its details
      if (selectedProject?.id === project.id) {
        await fetchProjectDetails(project.id);
      }
    } catch (error: any) {
      console.error('Error starting analysis:', error);
      alert(`Error: ${error.message}`);
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleProjectClick = (project: Project) => {
    setSelectedProject(project);
    fetchProjectDetails(project.id);
    setViewMode('details');
  };

  const handleStopAnalysis = async (sessionId: string, projectId: string) => {
    if (!confirm('Are you sure you want to stop this analysis? Progress will be saved but no new queries will be processed.')) {
        return;
      }

    setStoppingAnalysis(sessionId);
      try {
      const { error } = await supabase
          .from('brand_analysis_sessions')
        .update({
          status: 'cancelled',
          completed_at: new Date().toISOString(),
          results_summary: {
            cancelled: true,
            cancelled_at: new Date().toISOString(),
            partial_results: true
          }
        })
        .eq('id', sessionId);

      if (error) throw error;

      // Refresh data
      await fetchProjects();
      if (selectedProject && selectedProject.id === projectId) {
        await fetchProjectDetails(projectId);
      }
    } catch (error) {
      console.error('Error stopping analysis:', error);
      alert('Failed to stop analysis. Please try again.');
    } finally {
      setStoppingAnalysis(null);
    }
  };

  const handleNewAnalysis = () => {
    setViewMode('form');
    setCurrentStep(1);
    setHasAutoGeneratedAI(false);
    setFetchGSCKeywords(false);
  };

  const handleBack = () => {
    if (viewMode === 'details') {
      setViewMode('projects');
      setSelectedProject(null);
    } else if (viewMode === 'form' && currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  const handleNext = async () => {
    if (currentStep === 1) {
      if (!brandName.trim() || !websiteUrl.trim() || !industry) {
        alert("Please fill in all required fields");
        return;
      }
      
      // Generate AI suggestions BEFORE moving to Step 2 (only once per session)
      if (!hasAutoGeneratedAI) {
        setHasAutoGeneratedAI(true);
        
        // Start generating AI suggestions
        await generateAISuggestions();
        
        // After generation completes, move to Step 2
        if (currentStep < totalSteps) {
          setCurrentStep(currentStep + 1);
        }
      } else {
        // If already generated, just move to next step
        if (currentStep < totalSteps) {
          setCurrentStep(currentStep + 1);
        }
      }
      return;
    }
    
    if (currentStep < totalSteps) {
      setCurrentStep(currentStep + 1);
    }
  };

  const addCompetitor = () => {
    if (newCompetitor.trim() && !competitors.includes(newCompetitor.trim())) {
      setCompetitors([...competitors, newCompetitor.trim()]);
      setNewCompetitor("");
    }
  };

  const addKeyword = () => {
    if (newKeyword.trim() && !keywords.includes(newKeyword.trim())) {
      setKeywords([...keywords, newKeyword.trim()]);
      setNewKeyword("");
    }
  };

  // Generate AI-powered suggestions for competitors and keywords
  const generateAISuggestions = async () => {
    // Validate that Step 1 is complete
    if (!brandName.trim() || !websiteUrl.trim() || !industry) {
      alert("Please complete Brand Setup (Step 1) first before generating AI suggestions.");
      return;
    }

    setIsGeneratingAI(true);
    try {
      console.log('ðŸ¤– Generating AI suggestions...');
      
      const response = await fetch('/api/ai-suggestions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          brandName,
          websiteUrl,
          industry,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to generate suggestions');
      }

      const data = await response.json();

      if (data.success) {
        // Update competitors and keywords with AI suggestions
        if (data.competitors && data.competitors.length > 0) {
          setCompetitors(data.competitors);
        }
        if (data.keywords && data.keywords.length > 0) {
          setKeywords(data.keywords);
        }

        console.log(`âœ… Generated ${data.competitors.length} competitors and ${data.keywords.length} keywords`);
      } else {
        throw new Error('No suggestions generated');
      }
    } catch (error) {
      console.error('Error generating AI suggestions:', error);
      alert(error instanceof Error ? error.message : 'Failed to generate AI suggestions. Please try again or enter manually.');
    } finally {
      setIsGeneratingAI(false);
    }
  };

  // Calculate overall stats
  const overallStats = {
    totalMentions: projects.reduce((sum, p) => sum + getProjectStats(p.id).mentions, 0),
    activePlatforms: new Set(projects.flatMap(p => p.active_platforms || [])).size,
    avgVisibility: projects.length > 0 
      ? Math.round(projects.reduce((sum, p) => sum + getProjectStats(p.id).visibility, 0) / projects.length)
      : 0,
  };

  // Render Projects List View
  if (viewMode === 'projects') {
    return (
      <div className="min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8">
        <div className="max-w-7xl mx-auto">
          {/* Header */}
          <div className="mb-8 flex items-center justify-between">
            <div>
              <div className="flex items-center gap-2 mb-2">
                <h1 className="text-3xl font-bold text-gray-900">Brand Analysis</h1>
                <TrendingUp className="w-6 h-6 text-green-500" />
              </div>
              <p className="text-gray-600">Analyze your brand's AI visibility and competitive positioning</p>
            </div>
            <button
              onClick={handleNewAnalysis}
              className="flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
            >
              <Plus className="w-5 h-5" />
              New Analysis
            </button>
          </div>

          {/* Key Metrics */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div className="bg-white border-2 border-purple-200 rounded-lg p-6">
              <div className="flex items-center justify-between mb-2">
                <Search className="w-5 h-5 text-purple-600" />
                <span className="text-2xl font-bold text-gray-900">{overallStats.totalMentions}</span>
              </div>
              <p className="text-sm text-gray-600">Total Mentions</p>
              <p className="text-xs text-gray-500 mt-1">across all brands</p>
            </div>
            <div className="bg-white border-2 border-purple-200 rounded-lg p-6">
              <div className="flex items-center justify-between mb-2">
                <Target className="w-5 h-5 text-purple-600" />
                <span className="text-2xl font-bold text-gray-900">{overallStats.activePlatforms}</span>
              </div>
              <p className="text-sm text-gray-600">AI Platforms</p>
              <p className="text-xs text-gray-500 mt-1">active platforms</p>
            </div>
            <div className="bg-white rounded-lg p-6">
              <div className="flex items-center justify-between mb-2">
                <Eye className="w-5 h-5 text-gray-400" />
                <span className="text-2xl font-bold text-gray-900">{overallStats.avgVisibility}%</span>
              </div>
              <p className="text-sm text-gray-600">Avg Visibility</p>
              <p className="text-xs text-gray-500 mt-1">mention rate</p>
            </div>
            <div className="bg-white border-2 border-red-200 rounded-lg p-6">
              <div className="flex items-center justify-between mb-2">
                <BarChart3 className="w-5 h-5 text-red-600" />
                <span className="text-2xl font-bold text-gray-900">0%</span>
              </div>
              <p className="text-sm text-gray-600">Avg Sentiment</p>
              <p className="text-xs text-gray-500 mt-1">-100%</p>
            </div>
          </div>

          {/* Projects Grid */}
          <div>
            <h2 className="text-xl font-semibold text-gray-900 mb-4">
              Your Brand Projects ({projects.length})
            </h2>
            {loading ? (
              <div className="flex items-center justify-center p-12">
                <RefreshCw className="w-6 h-6 animate-spin text-purple-600" />
              </div>
            ) : projects.length === 0 ? (
              <div className="bg-white rounded-lg p-12 text-center">
                <Target className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <h3 className="text-lg font-semibold text-gray-900 mb-2">No projects yet</h3>
                <p className="text-gray-600 mb-4">Start by creating your first brand analysis</p>
                <button
                  onClick={handleNewAnalysis}
                  className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                >
                  New Analysis
                </button>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {projects.map((project) => {
                  const session = getProjectSession(project.id);
                  const stats = getProjectStats(project.id);
                  const isRunning = session?.status === 'running';
                  const isCancelled = session?.status === 'cancelled';
                  const progress = session && session.total_queries 
            ? Math.round((session.completed_queries || 0) / session.total_queries * 100)
            : 0;

                  return (
                    <div
                      key={project.id}
                      className="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-lg transition-shadow cursor-pointer"
                      onClick={() => handleProjectClick(project)}
                    >
                      {/* Brand Header */}
                      <div className="flex items-start justify-between mb-4">
                        <div className="flex items-center gap-3 flex-1">
                          {project.company_image_url ? (
                            <img 
                              src={project.company_image_url} 
                              alt={project.brand_name}
                              className="w-12 h-12 rounded-lg object-cover"
                              onError={(e) => {
                                // Fallback to initial if image fails to load
                                e.currentTarget.style.display = 'none';
                                const fallback = e.currentTarget.nextElementSibling as HTMLElement;
                                if (fallback) fallback.style.display = 'flex';
                              }}
                            />
                          ) : null}
                          <div className={`w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center ${project.company_image_url ? 'hidden' : ''}`}>
                            <span className="text-xl font-bold text-purple-600">
                              {project.brand_name.charAt(0).toUpperCase()}
                            </span>
                          </div>
                          <div className="flex-1 min-w-0">
                            <h3 className="font-semibold text-gray-900">{project.brand_name}</h3>
                            <div className="flex items-center gap-2 mt-1">
                              {isRunning ? (
                                <span className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs flex items-center gap-1">
                                  <RefreshCw className="w-3 h-3 animate-spin" />
                                  Running
                                </span>
                              ) : isCancelled ? (
                                <span className="px-2 py-0.5 bg-gray-100 text-gray-800 rounded text-xs flex items-center gap-1">
                                  <X className="w-3 h-3" />
                                  Cancelled
                                </span>
                              ) : (
                                <span className="px-2 py-0.5 bg-green-100 text-green-800 rounded text-xs">Active</span>
                              )}
                              <span className="text-xs text-gray-500 capitalize">{project.industry}</span>
                            </div>
                          </div>
                        </div>
                        <div className="relative">
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setOpenDropdown(openDropdown === project.id ? null : project.id);
                            }}
                            className="p-1 hover:bg-gray-100 rounded transition-colors"
                            disabled={deletingProject === project.id}
                          >
                            {deletingProject === project.id ? (
                              <RefreshCw className="w-4 h-4 text-gray-400 animate-spin" />
                            ) : (
                              <Settings className="w-4 h-4 text-gray-400 hover:text-gray-600" />
                            )}
                          </button>
                          {openDropdown === project.id && (
                            <>
                              <div
                                className="fixed inset-0 z-10"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setOpenDropdown(null);
                                }}
                              />
                              <div className="absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-20">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleDeleteProject(project.id, project.brand_name);
                                  }}
                                  className="w-full flex items-center gap-2 px-4 py-2 text-left text-red-600 hover:bg-red-50 transition-colors rounded-lg"
                                  disabled={deletingProject === project.id}
                                >
                                  <Trash2 className="w-4 h-4" />
                                  <span>Delete Analysis</span>
                                </button>
                              </div>
                            </>
                          )}
                        </div>
                      </div>

                      {/* Company Description */}
                      {project.company_description && (
                        <div className="text-sm text-gray-600 mb-3 line-clamp-3">
                          {project.company_description.split('\n').slice(0, 3).join(' ')}
                        </div>
                      )}

                      {/* Date */}
                      <div className="text-xs text-gray-500 mb-4">
                        {session?.started_at 
                          ? new Date(session.started_at).toLocaleDateString()
                          : project.last_analysis_at
                          ? new Date(project.last_analysis_at).toLocaleDateString()
                          : 'No analysis yet'}
                      </div>

                      {/* Progress Bar for Running */}
                      {isRunning && (
                        <div className="mb-4">
                          <div className="flex items-center justify-between text-xs text-gray-600 mb-1">
                            <span>Progress</span>
                            <span>{progress}%</span>
                          </div>
                          <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div
                              className="h-full bg-blue-600 transition-all duration-300"
                              style={{ width: `${progress}%` }}
                            />
                          </div>
                        </div>
                      )}

                      {/* Stats */}
                      <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                          <div className="text-sm text-gray-600">Mentions</div>
                          <div className="text-2xl font-bold text-gray-900">{stats.mentions}</div>
                        </div>
                        <div>
                          <div className="text-sm text-gray-600">Visibility</div>
                          <div className="text-2xl font-bold text-gray-900">{stats.visibility}%</div>
                        </div>
                      </div>

                      {/* Platforms */}
                      <div className="mb-4">
                        <div className="text-xs text-gray-600 mb-2">Active Platforms</div>
                        <div className="flex flex-wrap gap-2">
                          {(project.active_platforms || []).slice(0, 5).map((platform) => {
                            const platformOption = platformOptions.find(p => p.id === platform);
                            return (
                              <span
                                key={platform}
                                className="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded capitalize flex items-center gap-1"
                                title={platformOption?.name || platform}
                              >
                                {platformOption?.icon ? (
                                  <Image 
                                    src={platformOption.icon} 
                                    alt={platformOption.name} 
                                    width={platformOption.id === 'gemini' ? 32 : 16} 
                                    height={platformOption.id === 'gemini' ? 32 : 16} 
                                    className={`${platformOption.id === 'gemini' ? 'w-8 h-8' : 'w-4 h-4'} object-contain ${platformOption.id === 'gemini' ? 'brightness-110 contrast-110' : ''}`}
                                    quality={platformOption.id === 'gemini' ? 100 : 75}
                                    unoptimized={platformOption.id === 'gemini'}
                                  />
                                ) : (
                                  platform
                                )}
                              </span>
                            );
                          })}
                        </div>
                      </div>

                      {/* Action Buttons */}
                      <div className="flex gap-2">
                        {isRunning && session?.id && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              handleStopAnalysis(session.id, project.id);
                            }}
                            disabled={stoppingAnalysis === session.id}
                            className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            {stoppingAnalysis === session.id ? (
                              <>
                                <RefreshCw className="w-4 h-4 animate-spin" />
                                Stopping...
                              </>
                            ) : (
                              <>
                                <StopCircle className="w-4 h-4" />
                                Stop
                              </>
                            )}
                          </button>
                        )}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            handleProjectClick(project);
                          }}
                          className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                        >
                          <TrendingUp className="w-4 h-4" />
                          View Results
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // Render Project Details View
  if (viewMode === 'details' && selectedProject) {
    const latestSession = projectSessions[0];
    const isRunning = latestSession?.status === 'running';
    const progress = latestSession && latestSession.total_queries 
      ? Math.round((latestSession.completed_queries || 0) / latestSession.total_queries * 100)
      : 0;

    return (
      <div className="min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8">
        <div className="max-w-7xl mx-auto">
          {/* Analysis Start Notification Banner */}
          {showAnalysisStartNotification && (
            <div className="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4 animate-pulse">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <RefreshCw className="w-5 h-5 text-blue-600 animate-spin" />
                  <div>
                    <div className="text-sm font-semibold text-blue-900">Analysis Started!</div>
                    <div className="text-xs text-blue-700">Your analysis is running in the background</div>
                  </div>
                </div>
                <button
                  onClick={() => setShowAnalysisStartNotification(false)}
                  className="text-blue-400 hover:text-blue-600 transition-colors"
                >
                  <X className="w-4 h-4" />
                </button>
              </div>
            </div>
          )}

          {/* Back Button */}
          <button
            onClick={handleBack}
            className="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-4"
          >
            <ArrowLeft className="w-4 h-4" />
            Back to Projects
          </button>

          {/* Project Header */}
          <div className="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <div className="flex items-start justify-between mb-4">
              <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                  {selectedProject.company_image_url ? (
                    <img 
                      src={selectedProject.company_image_url} 
                      alt={selectedProject.brand_name}
                      className="w-12 h-12 rounded-lg object-cover border border-gray-200"
                      onError={(e) => {
                        // Fallback to initial if image fails to load
                        e.currentTarget.style.display = 'none';
                        const fallback = e.currentTarget.nextElementSibling as HTMLElement;
                        if (fallback) fallback.style.display = 'flex';
                      }}
                    />
                  ) : null}
                  <div className={`w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center ${selectedProject.company_image_url ? 'hidden' : ''}`}>
                    <span className="text-xl font-bold text-purple-600">
                      {selectedProject.brand_name.charAt(0).toUpperCase()}
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    <h1 className="text-2xl font-bold text-gray-900">{selectedProject.brand_name}</h1>
                    <span className="px-2 py-1 bg-gray-100 text-gray-700 rounded text-sm capitalize">
                      {selectedProject.industry}
                    </span>
                  </div>
                </div>
                {selectedProject.website_url && (
                  <div className="flex items-center gap-2 text-gray-600 mb-3">
                    <Globe className="w-4 h-4" />
                    <span>{selectedProject.website_url}</span>
                  </div>
                )}
                {/* Company Description from Crawler */}
                {selectedProject.company_description && (
                  <div className="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div className="text-xs font-semibold text-gray-700 mb-1">About {selectedProject.brand_name}</div>
                    <div className="text-sm text-gray-600 whitespace-pre-line">
                      {selectedProject.company_description}
                    </div>
                  </div>
                )}
              </div>
              <div className="text-sm text-gray-500 ml-4">
                Updated {selectedProject.last_analysis_at 
                  ? new Date(selectedProject.last_analysis_at).toLocaleString()
                  : new Date(selectedProject.created_at).toLocaleString()}
              </div>
            </div>
            
            {/* Selected Platforms/LLMs */}
            {selectedProject.active_platforms && selectedProject.active_platforms.length > 0 && (
              <div className="border-t border-gray-200 pt-4 mt-4">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-sm font-semibold text-gray-700">AI Platforms Selected for Analysis:</span>
                </div>
                <div className="flex flex-wrap gap-2">
                  {selectedProject.active_platforms.map((platform) => {
                    const platformOption = platformOptions.find(p => p.id === platform);
                    return (
                      <div
                        key={platform}
                        className="flex items-center gap-2 px-3 py-2 bg-purple-50 border border-purple-200 rounded-lg"
                      >
                        {platformOption?.icon ? (
                          <Image 
                            src={platformOption.icon} 
                            alt={platformOption.name} 
                            width={platformOption.id === 'gemini' ? 36 : 20} 
                            height={platformOption.id === 'gemini' ? 36 : 20} 
                            className={`${platformOption.id === 'gemini' ? 'w-9 h-9' : 'w-5 h-5'} object-contain ${platformOption.id === 'gemini' ? 'brightness-110 contrast-110' : ''}`}
                            quality={platformOption.id === 'gemini' ? 100 : 75}
                            unoptimized={platformOption.id === 'gemini'}
                          />
                        ) : (
                          <span className="text-lg">ðŸ¤–</span>
                        )}
                        <span className="text-sm font-medium text-gray-900 capitalize">
                          {platformOption?.name || platform}
                        </span>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
            {/* Main Content */}
            <div className="lg:col-span-3 space-y-6">
              {/* Metrics Cards */}
              <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div className="bg-white rounded-lg border border-gray-200 p-4">
                  <div className="text-sm text-gray-600 mb-1">AI Platforms</div>
                  <div className="text-2xl font-bold text-gray-900">
                    {projectStats?.platforms_analyzed?.length || new Set(projectResponses.map(r => r.platform)).size || selectedProject.active_platforms?.length || 0}
                  </div>
                  <div className="flex flex-wrap gap-1 mt-2">
                    {(() => {
                      const platforms = projectStats?.platforms_analyzed || Array.from(new Set(projectResponses.map(r => r.platform))) || selectedProject.active_platforms || [];
                      return platforms.slice(0, 4).map((platform: string) => {
                        const platformOption = platformOptions.find(p => p.id === platform);
                        return (
                          <span key={platform} className="text-xs flex items-center" title={platformOption?.name || platform}>
                            {platformOption?.icon ? (
                              <Image 
                                src={platformOption.icon} 
                                alt={platformOption.name} 
                                width={platformOption.id === 'gemini' ? 32 : 16} 
                                height={platformOption.id === 'gemini' ? 32 : 16} 
                                className={`${platformOption.id === 'gemini' ? 'w-8 h-8' : 'w-4 h-4'} object-contain ${platformOption.id === 'gemini' ? 'brightness-110 contrast-110' : ''}`}
                                quality={platformOption.id === 'gemini' ? 100 : 75}
                                unoptimized={platformOption.id === 'gemini'}
                              />
                            ) : (
                              platform
                            )}
                          </span>
                        );
                      });
                    })()}
                  </div>
                </div>
                <div className="bg-white rounded-lg border border-gray-200 p-4">
                  <div className="text-sm text-gray-600 mb-1">Total Mentions</div>
                  <div className="text-2xl font-bold text-gray-900">
                    {projectStats?.total_mentions || projectResponses.filter(r => r.response_metadata?.brand_mentioned).length || 0}
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    Across {projectStats?.platforms_analyzed?.length || new Set(projectResponses.map(r => r.platform)).size || 0} platforms
                  </div>
                </div>
                <div className="bg-white rounded-lg border border-gray-200 p-4">
                  <div className="text-sm text-gray-600 mb-1">Avg Sentiment</div>
                  <div className="text-2xl font-bold text-gray-900">
                    {(() => {
                      const sentiments = projectResponses
                        .filter(r => r.response_metadata?.brand_mentioned && r.response_metadata?.sentiment_score !== null)
                        .map(r => r.response_metadata.sentiment_score);
                      if (sentiments.length === 0) return '0%';
                      const avgSentiment = sentiments.reduce((sum, s) => sum + s, 0) / sentiments.length;
                      return `${Math.round(avgSentiment * 100)}%`;
                    })()}
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    Based on {projectResponses.filter(r => r.response_metadata?.brand_mentioned && r.response_metadata?.sentiment_score !== null).length || 0} mentions
                  </div>
                </div>
                <div className="bg-white rounded-lg border border-gray-200 p-4">
                  <div className="text-sm text-gray-600 mb-1">Competitor Mentions</div>
                  <div className="text-2xl font-bold text-gray-900">
                    {(() => {
                      const competitorMentions = projectResponses.reduce((total, response) => {
                        const competitors = response.response_metadata?.competitors_found || [];
                        return total + competitors.length;
                      }, 0);
                      return competitorMentions;
                    })()}
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {(() => {
                      const competitorMap: Record<string, number> = {};
                      projectResponses.forEach((response) => {
                        const competitors = response.response_metadata?.competitors_found || [];
                        competitors.forEach((comp: string) => {
                          competitorMap[comp] = (competitorMap[comp] || 0) + 1;
                        });
                      });
                      const topCompetitor = Object.entries(competitorMap).sort((a, b) => b[1] - a[1])[0];
                      return topCompetitor ? `Top: ${topCompetitor[0]}` : 'Top: -';
                    })()}
                  </div>
                </div>
                <div className="bg-white rounded-lg border border-gray-200 p-4">
                  <div className="text-sm text-gray-600 mb-1">Visibility Score</div>
                  <div className="text-2xl font-bold text-gray-900">
                    {projectStats 
                      ? Math.round((projectStats.mention_rate || 0) * 100) 
                      : projectResponses.length > 0
                      ? Math.round((projectResponses.filter(r => r.response_metadata?.brand_mentioned).length / projectResponses.length) * 100)
                      : 0}%
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    Your brand appears in {projectStats?.total_mentions || projectResponses.filter(r => r.response_metadata?.brand_mentioned).length || 0} of {projectStats?.total_queries || projectResponses.length || 100} prompts
                  </div>
                </div>
              </div>

              {/* Tabs */}
              <div className="bg-white rounded-lg border border-gray-200">
                <div className="border-b border-gray-200 flex overflow-x-auto">
                  {[
                    { id: 'summary', label: 'Summary', icon: FileText },
                    { id: 'results', label: 'Results', icon: BarChart3 },
                    { id: 'competitors', label: 'Competitors', icon: Target },
                    { id: 'sources', label: 'Sources', icon: Globe },
                    { id: 'analytics', label: 'Analytics', icon: Activity },
                    { id: 'keywords', label: 'Keywords', icon: Search },
                  ].map((tab) => {
                    const Icon = tab.icon;
                    return (
                      <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        className={`flex items-center gap-2 px-6 py-4 border-b-2 transition-colors ${
                          activeTab === tab.id
                            ? 'border-purple-600 text-purple-600'
                            : 'border-transparent text-gray-600 hover:text-gray-900'
                        }`}
                      >
                        <Icon className="w-4 h-4" />
                        <span>{tab.label}</span>
                      </button>
                    );
                  })}
                </div>

                {/* Tab Content */}
                <div className="p-6">
                  {activeTab === 'summary' && (
                    <div className="space-y-6">
                      {/* Overview Stats */}
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900 mb-4">Analysis Overview</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                          <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <div className="text-sm text-gray-600 mb-1">Total Queries</div>
                            <div className="text-2xl font-bold text-purple-600">
                              {projectStats?.total_queries || projectResponses.length || 0}
                            </div>
                          </div>
                          <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div className="text-sm text-gray-600 mb-1">Brand Mentions</div>
                            <div className="text-2xl font-bold text-green-600">
                              {projectStats?.total_mentions || projectResponses.filter(r => r.response_metadata?.brand_mentioned).length || 0}
                            </div>
                          </div>
                          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div className="text-sm text-gray-600 mb-1">Mention Rate</div>
                            <div className="text-2xl font-bold text-blue-600">
                              {projectStats 
                                ? Math.round((projectStats.mention_rate || 0) * 100) 
                                : projectResponses.length > 0
                                ? Math.round((projectResponses.filter(r => r.response_metadata?.brand_mentioned).length / projectResponses.length) * 100)
                                : 0}%
                            </div>
                          </div>
                          <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <div className="text-sm text-gray-600 mb-1">Platforms</div>
                            <div className="text-2xl font-bold text-orange-600">
                              {projectStats?.platforms_analyzed?.length || new Set(projectResponses.map(r => r.platform)).size || 0}
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Platform Breakdown */}
                      {projectResponses.length > 0 && (
                        <div>
                          <h3 className="text-lg font-semibold text-gray-900 mb-4">Platform Performance</h3>
                          <div className="space-y-3">
                            {Array.from(new Set(projectResponses.map(r => r.platform))).map((platform) => {
                              const platformResponses = projectResponses.filter(r => r.platform === platform);
                              const mentions = platformResponses.filter(r => r.response_metadata?.brand_mentioned).length;
                              const mentionRate = platformResponses.length > 0 ? (mentions / platformResponses.length) * 100 : 0;
                              const avgSentiment = platformResponses
                                .filter(r => r.response_metadata?.sentiment_score !== null)
                                .reduce((sum, r) => sum + (r.response_metadata?.sentiment_score || 0), 0) / 
                                platformResponses.filter(r => r.response_metadata?.sentiment_score !== null).length || 0;

                              const platformOption = platformOptions.find(p => p.id === platform);
                              return (
                                <div key={platform} className="border border-gray-200 rounded-lg p-4">
                                  <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-3">
                                      <span className="px-3 py-1 bg-gray-100 text-gray-800 rounded text-sm font-medium capitalize flex items-center gap-2">
                                        {platformOption?.icon ? (
                                          <Image 
                                            src={platformOption.icon} 
                                            alt={platformOption.name} 
                                            width={platformOption.id === 'gemini' ? 32 : 16} 
                                            height={platformOption.id === 'gemini' ? 32 : 16} 
                                            className={`${platformOption.id === 'gemini' ? 'w-8 h-8' : 'w-4 h-4'} object-contain ${platformOption.id === 'gemini' ? 'brightness-110 contrast-110' : ''}`}
                                            quality={platformOption.id === 'gemini' ? 100 : 75}
                                            unoptimized={platformOption.id === 'gemini'}
                                          />
                                        ) : null}
                                        {platform}
                                      </span>
                                      <span className="text-sm text-gray-600">
                                        {platformResponses.length} queries
                                      </span>
                                    </div>
                                    <span className="text-sm font-semibold text-gray-900">
                                      {Math.round(mentionRate)}% mention rate
                                    </span>
                                  </div>
                                  <div className="flex items-center gap-4 text-sm">
                                    <span className="text-gray-600">
                                      Mentions: <span className="font-semibold text-gray-900">{mentions}</span>
                                    </span>
                                    {!isNaN(avgSentiment) && avgSentiment !== 0 && (
                                      <span className="text-gray-600">
                                        Avg Sentiment: <span className={`font-semibold ${
                                          avgSentiment > 0.3 ? 'text-green-600' : avgSentiment < -0.3 ? 'text-red-600' : 'text-gray-600'
                                        }`}>
                                          {avgSentiment.toFixed(2)}
                                        </span>
                                      </span>
                                    )}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {/* Recent Activity */}
                      {projectSessions.length > 0 && (
                        <div>
                          <h3 className="text-lg font-semibold text-gray-900 mb-4">Analysis Sessions</h3>
                          <div className="space-y-2">
                            {projectSessions.slice(0, 5).map((session) => (
                              <div key={session.id} className="border border-gray-200 rounded-lg p-3 flex items-center justify-between">
                                <div>
                                  <div className="text-sm font-medium text-gray-900">
                                    {session.session_name || 'Analysis Session'}
                                  </div>
                                  <div className="text-xs text-gray-500">
                                    {new Date(session.started_at).toLocaleString()}
                                  </div>
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className={`px-2 py-1 rounded text-xs ${
                                    session.status === 'completed' ? 'bg-green-100 text-green-800' :
                                    session.status === 'running' ? 'bg-blue-100 text-blue-800' :
                                    session.status === 'cancelled' ? 'bg-gray-100 text-gray-800' :
                                    'bg-red-100 text-red-800'
                                  }`}>
                                    {session.status}
                                  </span>
                                  {session.status === 'completed' && session.results_summary && (
                                    <span className="text-xs text-gray-600">
                                      {session.results_summary.total_mentions || 0} mentions
                                    </span>
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {projectResponses.length === 0 && !projectSessions.find(s => s.status === 'running') && (
                        <div className="text-center py-12 text-gray-500">
                          <FileText className="w-12 h-12 mx-auto mb-4 text-gray-400" />
                          <p>No analysis data available</p>
                          <p className="text-sm mt-2">Run an analysis to see summary data here</p>
                        </div>
                      )}
                    </div>
                  )}
                  {activeTab === 'results' && (
                    <div>
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-gray-900">
                          {(() => {
                            const filteredResponses = resultsView === 'mentioned'
                              ? projectResponses.filter(r => r.response_metadata?.brand_mentioned)
                              : projectResponses.filter(r => !r.response_metadata?.brand_mentioned);
                            
                            // Group by prompt to count unique prompts
                            const uniquePrompts = new Set(
                              filteredResponses.map(r => r.prompt?.trim().toLowerCase() || '').filter(Boolean)
                            );
                            
                            return resultsView === 'mentioned'
                              ? `Mentioned Prompts (${uniquePrompts.size})`
                              : `Missed Prompts (${uniquePrompts.size})`;
                          })()}
                        </h3>
                        <div className="flex gap-2">
                          <button 
                            onClick={() => setResultsView('mentioned')}
                            className={`px-4 py-2 rounded-lg text-sm transition-colors ${
                              resultsView === 'mentioned'
                                ? 'bg-purple-600 text-white'
                                : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
                            }`}
                          >
                            Mentioned Prompts
                          </button>
                          <button 
                            onClick={() => setResultsView('missed')}
                            className={`px-4 py-2 rounded-lg text-sm transition-colors ${
                              resultsView === 'missed'
                                ? 'bg-purple-600 text-white'
                                : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
                            }`}
                          >
                            Missed Prompts
                          </button>
                        </div>
                      </div>
                      
                      {projectResponses.length === 0 ? (
                        <div className="text-center py-12 text-gray-500">
                          <Search className="w-12 h-12 mx-auto mb-4 text-gray-400" />
                          <p>No Analysis Results</p>
                          {projectSessions.find(s => s.project_id === selectedProject?.id)?.status === 'running' && (
                            <p className="text-sm mt-2">Analysis is still running. Results will appear here when complete.</p>
                          )}
                          {projectSessions.find(s => s.project_id === selectedProject?.id && s.status === 'completed') && (
                            <div className="mt-4">
                              <p className="text-sm text-gray-600 mb-2">No responses found in database.</p>
                              <button
                                onClick={() => {
                                  const session = projectSessions.find(s => s.project_id === selectedProject?.id && s.status === 'completed');
                                  if (session?.id) {
                                    fetchProjectResponses(session.id);
                                  }
                                }}
                                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm"
                              >
                                Refresh Responses
                              </button>
                            </div>
                          )}
                        </div>
                      ) : (
                        <div className="space-y-4">
                          {(() => {
                            const filteredResponses = resultsView === 'mentioned'
                              ? projectResponses.filter(r => r.response_metadata?.brand_mentioned)
                              : projectResponses.filter(r => !r.response_metadata?.brand_mentioned);

                            if (filteredResponses.length === 0) {
                              return (
                                <div className="text-center py-8 text-gray-500">
                                  <p>
                                    {resultsView === 'mentioned'
                                      ? `No brand mentions found in ${projectResponses.length} responses`
                                      : `All ${projectResponses.length} prompts mentioned your brand!`
                                    }
                                  </p>
                                </div>
                              );
                            }

                            // Group responses by prompt (same question)
                            const groupedByPrompt: Record<string, typeof filteredResponses> = {};
                            filteredResponses.forEach((response) => {
                              const promptKey = response.prompt?.trim().toLowerCase() || '';
                              if (!groupedByPrompt[promptKey]) {
                                groupedByPrompt[promptKey] = [];
                              }
                              groupedByPrompt[promptKey].push(response);
                            });

                            // Helper function to get model badge color
                            const getModelBadgeColor = (platform: string) => {
                              const platformLower = platform?.toLowerCase() || '';
                              if (platformLower.includes('claude')) return 'bg-orange-100 text-orange-800';
                              if (platformLower.includes('chatgpt') || platformLower.includes('gpt')) return 'bg-green-100 text-green-800';
                              if (platformLower.includes('gemini')) return 'bg-blue-100 text-blue-800';
                              if (platformLower.includes('perplexity')) return 'bg-purple-100 text-purple-800';
                              if (platformLower.includes('groq') || platformLower.includes('grok')) return 'bg-pink-100 text-pink-800';
                              return 'bg-gray-100 text-gray-800';
                            };

                            // Helper function to get model display name
                            const getModelDisplayName = (platform: string) => {
                              const platformLower = platform?.toLowerCase() || '';
                              if (platformLower.includes('claude')) return 'Claude';
                              if (platformLower.includes('chatgpt') || platformLower.includes('gpt')) return 'GPT';
                              if (platformLower.includes('gemini')) return 'Gemini';
                              if (platformLower.includes('perplexity')) return 'Perplexity';
                              if (platformLower.includes('groq') || platformLower.includes('grok')) return 'Groq';
                              return platform?.charAt(0).toUpperCase() + platform?.slice(1) || 'Unknown';
                            };

                            return Object.entries(groupedByPrompt).map(([promptKey, responses]) => {
                              const firstResponse = responses[0];
                              const uniquePrompt = firstResponse.prompt;

                              return (
                                <div
                                  key={promptKey}
                                  className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors"
                                >
                                  {/* Query Section - Show once at top */}
                                  <div className="mb-4">
                                    <div className="flex items-center justify-between mb-1">
                                      <div className="text-sm font-medium text-gray-700">Query:</div>
                                      {resultsView === 'missed' && (
                                        <button
                                          type="button"
                                          onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            // Store data in sessionStorage for the edit page
                                            const editData = {
                                              prompt: uniquePrompt,
                                              responses: responses.map(r => ({
                                                id: r.id,
                                                platform: r.platform,
                                                response: r.response,
                                                response_metadata: r.response_metadata
                                              })),
                                              projectId: selectedProject?.id,
                                              brandName: selectedProject?.brand_name,
                                              industry: selectedProject?.industry,
                                              keywords: selectedProject?.keywords || [],
                                              competitors: selectedProject?.competitors || []
                                            };
                                            sessionStorage.setItem('editPromptData', JSON.stringify(editData));
                                            router.push('/dashboard/content?source=ai-visibility&step=content-generation');
                                          }}
                                          className="flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium text-purple-600 hover:text-purple-700 hover:bg-purple-50 rounded-md transition-colors"
                                          title="Generate new optimized content for this prompt"
                                        >
                                          <Pencil className="w-3.5 h-3.5" />
                                          Generate New Content
                                        </button>
                                      )}
                                    </div>
                                    <div className="text-sm text-gray-900 bg-gray-50 p-2 rounded">
                                      {uniquePrompt}
                                    </div>
                                  </div>

                                  {/* Status Badge */}
                                  <div className="flex items-center justify-end mb-4">
                                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                                      resultsView === 'mentioned'
                                        ? 'bg-green-100 text-green-800'
                                        : 'bg-red-100 text-red-800'
                                    }`}>
                                      {resultsView === 'mentioned' ? 'Brand Mentioned' : 'Brand Not Mentioned'}
                                    </span>
                                  </div>

                                  {/* All Responses from Different Models */}
                                  <div className="space-y-3">
                                    {responses.map((response) => (
                                      <div
                                        key={response.id}
                                        className="border-l-2 border-gray-200 pl-3 py-2 bg-gray-50 rounded-r"
                                      >
                                        <div className="flex items-center justify-between mb-2">
                                          <span className={`px-2 py-1 rounded text-xs font-medium capitalize ${getModelBadgeColor(response.platform)}`}>
                                            {getModelDisplayName(response.platform)}
                                          </span>
                                          {resultsView === 'mentioned' && response.response_metadata?.sentiment_score !== null && (
                                            <span className={`px-2 py-1 rounded text-xs ${
                                              response.response_metadata.sentiment_score > 0.3
                                                ? 'bg-green-100 text-green-800'
                                                : response.response_metadata.sentiment_score < -0.3
                                                ? 'bg-red-100 text-red-800'
                                                : 'bg-gray-100 text-gray-800'
                                            }`}>
                                              Sentiment: {response.response_metadata.sentiment_score?.toFixed(2)}
                                            </span>
                                          )}
                                        </div>
                                        <div className="flex items-start gap-2">
                                          <div className="flex-1 text-sm text-gray-700 line-clamp-3">
                                            {response.response}
                                          </div>
                                          <button
                                            type="button"
                                            onClick={(e) => {
                                              e.preventDefault();
                                              e.stopPropagation();
                                              console.log('View button clicked', { response: response.id, prompt: uniquePrompt });
                                              setViewResponseModal({ open: true, response, prompt: uniquePrompt });
                                            }}
                                            className="flex-shrink-0 p-1.5 text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded transition-colors cursor-pointer"
                                            title="View full response"
                                          >
                                            <Eye className="w-4 h-4" />
                                          </button>
                                        </div>
                                        {resultsView === 'mentioned' && response.response_metadata?.sources && response.response_metadata.sources.length > 0 && (
                                          <div className="mt-2 pt-2 border-t border-gray-200">
                                            <div className="text-xs font-medium text-gray-600 mb-1">Sources:</div>
                                            <div className="flex flex-wrap gap-2">
                                              {response.response_metadata.sources.slice(0, 3).map((source: any, idx: number) => (
                                                <a
                                                  key={idx}
                                                  href={source.url}
                                                  target="_blank"
                                                  rel="noopener noreferrer"
                                                  className="text-xs text-blue-600 hover:underline truncate max-w-xs"
                                                >
                                                  {source.domain || source.url}
                                                </a>
                                              ))}
                                            </div>
                                          </div>
                                        )}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              );
                            });
                          })()}
                        </div>
                      )}
                    </div>
                  )}
                  {activeTab === 'competitors' && (
                    <div className="space-y-6">
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900 mb-4">Competitor Mentions</h3>
                        {projectResponses.length === 0 ? (
                          <div className="text-center py-12 text-gray-500">
                            <Target className="w-12 h-12 mx-auto mb-4 text-gray-400" />
                            <p>No competitor data available</p>
                            <p className="text-sm mt-2">Run an analysis to see competitor mentions</p>
                          </div>
                        ) : (() => {
                          // Aggregate competitor mentions from all responses
                          const competitorData: Record<string, {
                            mentions: number;
                            contexts: string[];
                            sentiment: 'positive' | 'negative' | 'mixed' | 'neutral';
                            platforms: Set<string>;
                            comparisons: number;
                          }> = {};

                          projectResponses.forEach((response) => {
                            const metadata = response.response_metadata;
                            if (metadata?.competitors_found && Array.isArray(metadata.competitors_found)) {
                              metadata.competitors_found.forEach((competitor: string) => {
                                if (!competitorData[competitor]) {
                                  competitorData[competitor] = {
                                    mentions: 0,
                                    contexts: [],
                                    sentiment: 'neutral',
                                    platforms: new Set(),
                                    comparisons: 0
                                  };
                                }
                                competitorData[competitor].mentions++;
                                competitorData[competitor].platforms.add(response.platform);
                                
                                const competitorContext = metadata.competitor_contexts?.[competitor];
                                if (competitorContext?.context) {
                                  competitorData[competitor].contexts.push(competitorContext.context);
                                }
                                if (competitorContext?.direct_comparison) {
                                  competitorData[competitor].comparisons++;
                                }
                                if (competitorContext?.sentiment) {
                                  competitorData[competitor].sentiment = competitorContext.sentiment;
                                }
                              });
                            }
                          });

                          const competitors = Object.entries(competitorData).sort((a, b) => b[1].mentions - a[1].mentions);

                          return competitors.length === 0 ? (
                            <div className="text-center py-12 text-gray-500">
                              <Target className="w-12 h-12 mx-auto mb-4 text-gray-400" />
                              <p>No competitors mentioned in responses</p>
                              {selectedProject?.competitors && Array.isArray(selectedProject.competitors) && selectedProject.competitors.length > 0 && (
                                <p className="text-sm mt-2">
                                  Tracked competitors: {selectedProject.competitors.join(', ')}
                                </p>
                              )}
                            </div>
                          ) : (
                            <div className="space-y-4">
                              {competitors.map(([competitor, data]) => (
                                <div key={competitor} className="border border-gray-200 rounded-lg p-4">
                                  <div className="flex items-start justify-between mb-3">
                                    <div>
                                      <h4 className="font-semibold text-gray-900">{competitor}</h4>
                                      <div className="flex items-center gap-4 mt-1 text-sm text-gray-600">
                                        <span>{data.mentions} mentions</span>
                                        <span>{data.platforms.size} platforms</span>
                                        {data.comparisons > 0 && (
                                          <span className="text-purple-600">{data.comparisons} direct comparisons</span>
                                        )}
                                      </div>
                                    </div>
                                    <span className={`px-2 py-1 rounded text-xs ${
                                      data.sentiment === 'positive' ? 'bg-green-100 text-green-800' :
                                      data.sentiment === 'negative' ? 'bg-red-100 text-red-800' :
                                      data.sentiment === 'mixed' ? 'bg-yellow-100 text-yellow-800' :
                                      'bg-gray-100 text-gray-800'
                                    }`}>
                                      {data.sentiment}
                                    </span>
                                  </div>
                                  <div className="flex flex-wrap gap-2 mb-3">
                                    {Array.from(data.platforms).map((platform) => {
                                      const platformOption = platformOptions.find(p => p.id === platform);
                                      return (
                                        <span key={platform} className="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs capitalize flex items-center gap-1">
                                          {platformOption?.icon ? (
                                            <Image 
                                              src={platformOption.icon} 
                                              alt={platformOption.name} 
                                              width={platformOption.id === 'gemini' ? 28 : 14} 
                                              height={platformOption.id === 'gemini' ? 28 : 14} 
                                              className={`${platformOption.id === 'gemini' ? 'w-7 h-7' : 'w-3.5 h-3.5'} object-contain ${platformOption.id === 'gemini' ? 'brightness-110 contrast-110' : ''}`}
                                              quality={platformOption.id === 'gemini' ? 100 : 75}
                                              unoptimized={platformOption.id === 'gemini'}
                                            />
                                          ) : null}
                                          {platform}
                                        </span>
                                      );
                                    })}
                                  </div>
                                  {data.contexts.length > 0 && (
                                    <div>
                                      <div className="text-sm font-medium text-gray-700 mb-2">Mention Context:</div>
                                      <div className="text-sm text-gray-600 bg-gray-50 p-3 rounded">
                                        {data.contexts[0]}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                  )}
                  {activeTab === 'sources' && (
                    <div className="space-y-6">
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900 mb-4">Sources & Citations</h3>
                        {projectResponses.length === 0 ? (
                          <div className="text-center py-12 text-gray-500">
                            <Globe className="w-12 h-12 mx-auto mb-4 text-gray-400" />
                            <p>No sources available</p>
                            <p className="text-sm mt-2">Sources will appear here when analysis completes</p>
                          </div>
                        ) : (() => {
                          // Aggregate all sources from responses
                          const sourcesMap: Record<string, {
                            url: string;
                            domain: string;
                            title?: string;
                            mentions: number;
                            platforms: Set<string>;
                            contexts: string[];
                          }> = {};

                          projectResponses.forEach((response) => {
                            const sources = response.response_metadata?.sources || [];
                            sources.forEach((source: any) => {
                              const key = source.url || source.domain;
                              if (key) {
                                if (!sourcesMap[key]) {
                                  sourcesMap[key] = {
                                    url: source.url || `https://${source.domain}`,
                                    domain: source.domain || new URL(source.url).hostname,
                                    title: source.title,
                                    mentions: 0,
                                    platforms: new Set(),
                                    contexts: []
                                  };
                                }
                                sourcesMap[key].mentions++;
                                sourcesMap[key].platforms.add(response.platform);
                              }
                            });
                          });

                          const sources = Object.values(sourcesMap).sort((a, b) => b.mentions - a.mentions);

                          return sources.length === 0 ? (
                            <div className="text-center py-12 text-gray-500">
                              <Globe className="w-12 h-12 mx-auto mb-4 text-gray-400" />
                              <p>No sources found in responses</p>
                            </div>
                          ) : (
                            <div className="space-y-3">
                              {sources.map((source, idx) => (
                                <div key={idx} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                  <div className="flex items-start justify-between mb-2">
                                    <div className="flex-1">
                                      <a
                                        href={source.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="text-blue-600 hover:underline font-medium"
                                      >
                                        {source.title || source.domain}
                                      </a>
                                      <div className="text-xs text-gray-500 mt-1">{source.domain}</div>
                                    </div>
                                    <div className="text-right">
                                      <div className="text-sm font-semibold text-gray-900">{source.mentions}</div>
                                      <div className="text-xs text-gray-500">mentions</div>
                                    </div>
                                  </div>
                                  <div className="flex flex-wrap gap-2 mt-2">
                                    {Array.from(source.platforms).map((platform) => {
                                      const platformOption = platformOptions.find(p => p.id === platform);
                                      return (
                                        <span key={platform} className="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs capitalize flex items-center gap-1">
                                          {platformOption?.icon ? (
                                            <Image 
                                              src={platformOption.icon} 
                                              alt={platformOption.name} 
                                              width={platformOption.id === 'gemini' ? 28 : 14} 
                                              height={platformOption.id === 'gemini' ? 28 : 14} 
                                              className={`${platformOption.id === 'gemini' ? 'w-7 h-7' : 'w-3.5 h-3.5'} object-contain ${platformOption.id === 'gemini' ? 'brightness-110 contrast-110' : ''}`}
                                              quality={platformOption.id === 'gemini' ? 100 : 75}
                                              unoptimized={platformOption.id === 'gemini'}
                                            />
                                          ) : null}
                                          {platform}
                                        </span>
                                      );
                                    })}
                                  </div>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                  )}
                  {activeTab === 'analytics' && (
                    <div className="space-y-6">
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900 mb-4">Analytics & Insights</h3>
                        {projectResponses.length === 0 ? (
                          <div className="text-center py-12 text-gray-500">
                            <Activity className="w-12 h-12 mx-auto mb-4 text-gray-400" />
                            <p>No analytics data available</p>
                            <p className="text-sm mt-2">Run an analysis to see analytics</p>
                          </div>
                        ) : (
                          <div className="space-y-6">
                            {/* Sentiment Distribution - Pie Chart */}
                            <div className="bg-white border border-gray-200 rounded-lg p-6">
                              <h4 className="text-md font-semibold text-gray-900 mb-4">Sentiment Distribution</h4>
                              {(() => {
                                const sentiments = projectResponses
                                  .filter(r => r.response_metadata?.sentiment_score !== null)
                                  .map(r => r.response_metadata.sentiment_score);
                                const positive = sentiments.filter(s => s > 0.3).length;
                                const negative = sentiments.filter(s => s < -0.3).length;
                                const neutral = sentiments.filter(s => s >= -0.3 && s <= 0.3).length;
                                const total = sentiments.length;

                                const sentimentData = [
                                  { name: 'Positive', value: positive, color: '#10b981', percentage: total > 0 ? Math.round((positive / total) * 100) : 0 },
                                  { name: 'Neutral', value: neutral, color: '#6b7280', percentage: total > 0 ? Math.round((neutral / total) * 100) : 0 },
                                  { name: 'Negative', value: negative, color: '#ef4444', percentage: total > 0 ? Math.round((negative / total) * 100) : 0 },
                                ].filter(item => item.value > 0);

                                if (sentimentData.length === 0) {
                                  return (
                                    <div className="text-center py-8 text-gray-500">
                                      <p>No sentiment data available</p>
                                    </div>
                                  );
                                }

                                return (
                                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <ResponsiveContainer width="100%" height={300}>
                                      <PieChart>
                                        <Pie
                                          data={sentimentData}
                                          cx="50%"
                                          cy="50%"
                                          labelLine={false}
                                          label={({ name, percentage }) => `${name}: ${percentage}%`}
                                          outerRadius={100}
                                          fill="#8884d8"
                                          dataKey="value"
                                        >
                                          {sentimentData.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={entry.color} />
                                          ))}
                                        </Pie>
                                        <Tooltip />
                                        <Legend />
                                      </PieChart>
                                    </ResponsiveContainer>
                                    <div className="flex flex-col justify-center space-y-4">
                                      {sentimentData.map((item) => (
                                        <div key={item.name} className="flex items-center justify-between p-3 rounded-lg" style={{ backgroundColor: `${item.color}15` }}>
                                          <div className="flex items-center gap-3">
                                            <div className="w-4 h-4 rounded-full" style={{ backgroundColor: item.color }}></div>
                                            <span className="font-medium text-gray-900">{item.name}</span>
                                          </div>
                                          <div className="text-right">
                                            <div className="text-lg font-bold" style={{ color: item.color }}>{item.value}</div>
                                            <div className="text-xs text-gray-500">{item.percentage}%</div>
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                );
                              })()}
                            </div>

                            {/* Platform Performance - Bar Chart */}
                            <div className="bg-white border border-gray-200 rounded-lg p-6">
                              <h4 className="text-md font-semibold text-gray-900 mb-4">Platform Performance</h4>
                              {(() => {
                                const platformData = Array.from(new Set(projectResponses.map(r => r.platform))).map((platform) => {
                                  const platformResponses = projectResponses.filter(r => r.platform === platform);
                                  const mentions = platformResponses.filter(r => r.response_metadata?.brand_mentioned).length;
                                  const total = platformResponses.length;
                                  const mentionRate = total > 0 ? (mentions / total) * 100 : 0;
                                  const platformOption = platformOptions.find(p => p.id === platform);
                                  
                                  return {
                                    platform: platformOption?.name || platform.charAt(0).toUpperCase() + platform.slice(1),
                                    mentions,
                                    total,
                                    mentionRate: Math.round(mentionRate),
                                    icon: platformOption?.icon || null
                                  };
                                }).sort((a, b) => b.mentionRate - a.mentionRate);

                                if (platformData.length === 0) {
                                  return (
                                    <div className="text-center py-8 text-gray-500">
                                      <p>No platform data available</p>
                                    </div>
                                  );
                                }

                                return (
                                  <ResponsiveContainer width="100%" height={300}>
                                    <BarChart data={platformData}>
                                      <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                                      <XAxis 
                                        dataKey="platform" 
                                        stroke="#6b7280"
                                        tick={{ fill: '#6b7280', fontSize: 12 }}
                                      />
                                      <YAxis 
                                        stroke="#6b7280"
                                        tick={{ fill: '#6b7280', fontSize: 12 }}
                                        label={{ value: 'Mention Rate (%)', angle: -90, position: 'insideLeft', style: { textAnchor: 'middle', fill: '#6b7280' } }}
                                      />
                                      <Tooltip 
                                        contentStyle={{ 
                                          backgroundColor: '#fff', 
                                          border: '1px solid #e5e7eb', 
                                          borderRadius: '8px',
                                          padding: '8px'
                                        }}
                                        formatter={(value: number, name: string) => {
                                          if (name === 'mentionRate') return [`${value}%`, 'Mention Rate'];
                                          if (name === 'mentions') return [`${value}`, 'Mentions'];
                                          return [value, name];
                                        }}
                                      />
                                      <Legend />
                                      <Bar 
                                        dataKey="mentionRate" 
                                        fill="#9333ea" 
                                        radius={[8, 8, 0, 0]}
                                        name="Mention Rate (%)"
                                      />
                                    </BarChart>
                                  </ResponsiveContainer>
                                );
                              })()}
                            </div>

                            {/* Platform Comparison - Stacked Bar Chart */}
                            <div className="bg-white border border-gray-200 rounded-lg p-6">
                              <h4 className="text-md font-semibold text-gray-900 mb-4">Platform Comparison</h4>
                              {(() => {
                                const comparisonData = Array.from(new Set(projectResponses.map(r => r.platform))).map((platform) => {
                                  const platformResponses = projectResponses.filter(r => r.platform === platform);
                                  const mentions = platformResponses.filter(r => r.response_metadata?.brand_mentioned).length;
                                  const total = platformResponses.length;
                                  const missed = total - mentions;
                                  const platformOption = platformOptions.find(p => p.id === platform);
                                  
                                  return {
                                    platform: platformOption?.name || platform.charAt(0).toUpperCase() + platform.slice(1),
                                    mentioned: mentions,
                                    missed: missed,
                                    total: total
                                  };
                                });

                                if (comparisonData.length === 0) {
                                  return (
                                    <div className="text-center py-8 text-gray-500">
                                      <p>No comparison data available</p>
                                    </div>
                                  );
                                }

                                return (
                                  <ResponsiveContainer width="100%" height={300}>
                                    <BarChart data={comparisonData}>
                                      <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                                      <XAxis 
                                        dataKey="platform" 
                                        stroke="#6b7280"
                                        tick={{ fill: '#6b7280', fontSize: 12 }}
                                      />
                                      <YAxis 
                                        stroke="#6b7280"
                                        tick={{ fill: '#6b7280', fontSize: 12 }}
                                        label={{ value: 'Number of Queries', angle: -90, position: 'insideLeft', style: { textAnchor: 'middle', fill: '#6b7280' } }}
                                      />
                                      <Tooltip 
                                        contentStyle={{ 
                                          backgroundColor: '#fff', 
                                          border: '1px solid #e5e7eb', 
                                          borderRadius: '8px',
                                          padding: '8px'
                                        }}
                                      />
                                      <Legend />
                                      <Bar 
                                        dataKey="mentioned" 
                                        stackId="a" 
                                        fill="#10b981" 
                                        name="Mentioned"
                                        radius={[0, 0, 0, 0]}
                                      />
                                      <Bar 
                                        dataKey="missed" 
                                        stackId="a" 
                                        fill="#ef4444" 
                                        name="Not Mentioned"
                                        radius={[8, 8, 0, 0]}
                                      />
                                    </BarChart>
                                  </ResponsiveContainer>
                                );
                              })()}
                            </div>

                            {/* Top Queries */}
                            <div className="bg-white border border-gray-200 rounded-lg p-6">
                              <h4 className="text-md font-semibold text-gray-900 mb-4">Top Performing Queries</h4>
                              <div className="space-y-2">
                                {projectResponses
                                  .filter(r => r.response_metadata?.brand_mentioned)
                                  .slice(0, 5)
                                  .map((response, idx) => (
                                    <div key={response.id} className="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 transition-colors">
                                      <div className="flex items-start justify-between">
                                        <div className="flex-1">
                                          <div className="flex items-center gap-2 mb-1">
                                            <span className="text-sm font-semibold text-gray-400">#{idx + 1}</span>
                                            <span className="text-sm font-medium text-gray-900 line-clamp-1">
                                              {response.prompt}
                                            </span>
                                          </div>
                                          <div className="flex items-center gap-2 text-xs text-gray-500">
                                            <span className="capitalize">{response.platform}</span>
                                            {response.response_metadata?.sentiment_score !== null && (
                                              <span className={`${
                                                response.response_metadata.sentiment_score > 0.3 ? 'text-green-600' :
                                                response.response_metadata.sentiment_score < -0.3 ? 'text-red-600' :
                                                'text-gray-600'
                                              }`}>
                                                Sentiment: {response.response_metadata.sentiment_score.toFixed(2)}
                                              </span>
                                            )}
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  ))}
                                {projectResponses.filter(r => r.response_metadata?.brand_mentioned).length === 0 && (
                                  <div className="text-center py-8 text-gray-500 text-sm">
                                    No brand mentions found
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                  {activeTab === 'keywords' && (
                    <KeywordsTab selectedProject={selectedProject} />
                  )}
                </div>
              </div>
            </div>

            {/* Sidebar */}
            <div className="lg:col-span-1 space-y-4">
              {/* Visibility Score */}
              <div className="bg-white rounded-lg border border-gray-200 p-6">
                <h3 className="font-semibold text-gray-900 mb-4">Visibility Score</h3>
                <div className="text-4xl font-bold text-gray-900 mb-2">
                  {projectStats ? Math.round((projectStats.mention_rate || 0) * 100) : 0}%
                </div>
                <p className="text-sm text-gray-600">
                  Your brand appears in {projectStats?.total_mentions || 0} of {projectStats?.total_queries || 0} prompts
                </p>
              </div>

              {/* Action Buttons */}
              <div className="space-y-3">
                <button className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                  <Settings className="w-4 h-4" />
                  Configure Project
                </button>
                <button className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                  <Download className="w-4 h-4" />
                  Export Report
                  <ChevronDown className="w-4 h-4" />
                </button>
                {/* Show Run Analysis button when not running */}
                {!isRunning && (
                  <button
                    onClick={() => {
                      if (!selectedProject) return;
                      handleRunAnalysis(selectedProject);
                    }}
                    disabled={isAnalyzing}
                    className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {isAnalyzing ? (
                      <>
                        <RefreshCw className="w-4 h-4 animate-spin" />
                        Starting...
                      </>
                    ) : (
                      <>
                        <Play className="w-4 h-4" />
                        Run Analysis
                      </>
                    )}
                  </button>
                )}

              </div>

              {/* Analysis Start Notification */}
              {showAnalysisStartNotification && (
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 animate-pulse">
                  <div className="flex items-center gap-2">
                    <RefreshCw className="w-5 h-5 text-blue-600 animate-spin" />
                    <div>
                      <div className="text-sm font-semibold text-blue-900">Analysis Started!</div>
                      <div className="text-xs text-blue-700">Your analysis is running in the background</div>
                    </div>
                  </div>
                </div>
              )}

              {/* Completion Notification */}
              {showCompletionNotification && (
                <div className="bg-green-50 border border-green-200 rounded-lg p-4 animate-pulse">
                  <div className="flex items-center gap-2">
                    <Check className="w-5 h-5 text-green-600" />
                    <div>
                      <div className="text-sm font-semibold text-green-900">Analysis Complete!</div>
                      <div className="text-xs text-green-700">Results are now available</div>
                    </div>
                  </div>
                </div>
              )}

              {/* Running Status */}
              {isRunning && latestSession?.id && (
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-medium text-gray-900">Progress</span>
                    <span className="text-sm font-semibold text-blue-600">{progress}%</span>
                  </div>
                  <div className="w-full h-2 bg-blue-200 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-blue-600 transition-all duration-300"
                      style={{ width: `${progress}%` }}
                    />
                  </div>
                  <div className="text-xs text-gray-600 mt-2 mb-3">
                    Processing {latestSession.completed_queries || 0} of {latestSession.total_queries || 0} queries
                  </div>
                  <button
                    onClick={() => handleStopAnalysis(latestSession.id, selectedProject!.id)}
                    disabled={stoppingAnalysis === latestSession.id}
                    className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {stoppingAnalysis === latestSession.id ? (
                      <>
                        <RefreshCw className="w-4 h-4 animate-spin" />
                        Stopping...
                      </>
                    ) : (
                      <>
                        <StopCircle className="w-4 h-4" />
                        Stop Analysis
                      </>
                    )}
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Analysis Start Modal */}
        {showAnalysisStartModal && analysisStartInfo && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div className="p-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-2xl font-bold text-gray-900">Analysis Started</h2>
                  <button
                    onClick={() => {
                      setShowAnalysisStartModal(false);
                      setAnalysisStartInfo(null);
                    }}
                    className="text-gray-400 hover:text-gray-600 transition-colors"
                  >
                    <X className="w-6 h-6" />
                  </button>
                </div>

                <div className="space-y-4">
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div className="flex items-center gap-2 mb-2">
                      <Check className="w-5 h-5 text-blue-600" />
                      <span className="text-sm font-semibold text-blue-900">Analysis is running in the background</span>
                    </div>
                    <p className="text-sm text-blue-700">
                      Your brand analysis has started successfully. You can close this window and continue working. 
                      Results will be available when the analysis completes.
                    </p>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-gray-50 rounded-lg p-4">
                      <div className="text-sm text-gray-600 mb-1">Platforms</div>
                      <div className="text-lg font-semibold text-gray-900">
                        {analysisStartInfo.platforms_count || analysisStartInfo.platforms_analyzed?.length || 0}
                      </div>
                      <div className="flex flex-wrap gap-1 mt-2">
                        {(analysisStartInfo.platforms_analyzed || []).map((platform: string) => {
                          const platformOption = platformOptions.find(p => p.id === platform);
                          return (
                            <span key={platform} className="text-xs px-2 py-1 bg-white rounded border border-gray-200 flex items-center gap-1">
                              {platformOption?.icon ? (
                                <Image 
                                  src={platformOption.icon} 
                                  alt={platformOption.name} 
                                  width={platformOption.id === 'gemini' ? 32 : 16} 
                                  height={platformOption.id === 'gemini' ? 32 : 16} 
                                  className={`${platformOption.id === 'gemini' ? 'w-8 h-8' : 'w-4 h-4'} object-contain ${platformOption.id === 'gemini' ? 'brightness-110 contrast-110' : ''}`}
                                  quality={platformOption.id === 'gemini' ? 100 : 75}
                                  unoptimized={platformOption.id === 'gemini'}
                                />
                              ) : null}
                              {platformOption?.name || platform}
                            </span>
                          );
                        })}
                      </div>
                    </div>

                    <div className="bg-gray-50 rounded-lg p-4">
                      <div className="text-sm text-gray-600 mb-1">Total Queries</div>
                      <div className="text-lg font-semibold text-gray-900">
                        {analysisStartInfo.total_queries || 0}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        Across all platforms
                      </div>
                    </div>
                  </div>

                  {analysisStartInfo.estimated_completion && (
                    <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                      <div className="text-sm font-semibold text-purple-900 mb-1">Estimated Completion</div>
                      <div className="text-sm text-purple-700">
                        {new Date(analysisStartInfo.estimated_completion).toLocaleString()}
                      </div>
                    </div>
                  )}

                  <div className="bg-gray-50 rounded-lg p-4">
                    <div className="text-sm font-semibold text-gray-900 mb-2">Session Information</div>
                    <div className="text-xs text-gray-600 space-y-1">
                      <div>Session ID: <span className="font-mono text-gray-900">{analysisStartInfo.session_id}</span></div>
                      <div>Status: <span className="text-blue-600 font-semibold">Running</span></div>
                    </div>
                  </div>
                </div>

                <div className="mt-6 flex justify-end">
                  <button
                    onClick={() => {
                      setShowAnalysisStartModal(false);
                      setAnalysisStartInfo(null);
                    }}
                    className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                  >
                    Got it
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

      {/* View Response Modal for Details View */}
      {viewResponseModal?.open && viewResponseModal?.response && (
        <div 
          className="fixed inset-0 flex items-center justify-center p-4"
          style={{ 
            zIndex: 99999,
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)'
          }}
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              setViewResponseModal(null);
            }
          }}
        >
          <div 
            className="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] flex flex-col shadow-2xl"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between p-6 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-900">Full Response</h3>
              <button
                onClick={() => setViewResponseModal(null)}
                className="text-gray-400 hover:text-gray-600 transition-colors"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            <div className="p-6 overflow-y-auto flex-1">
              <div className="mb-4">
                <div className="text-sm font-medium text-gray-700 mb-2">Query:</div>
                <div className="text-sm text-gray-900 bg-gray-50 p-3 rounded">
                  {viewResponseModal.prompt}
                </div>
              </div>
              <div className="mb-4">
                <div className="flex items-center gap-2 mb-2">
                  <span className={`px-3 py-1 rounded text-sm font-medium capitalize ${
                    viewResponseModal.response.platform?.toLowerCase().includes('claude') ? 'bg-orange-100 text-orange-800' :
                    viewResponseModal.response.platform?.toLowerCase().includes('chatgpt') || viewResponseModal.response.platform?.toLowerCase().includes('gpt') ? 'bg-green-100 text-green-800' :
                    viewResponseModal.response.platform?.toLowerCase().includes('gemini') ? 'bg-blue-100 text-blue-800' :
                    viewResponseModal.response.platform?.toLowerCase().includes('perplexity') ? 'bg-purple-100 text-purple-800' :
                    viewResponseModal.response.platform?.toLowerCase().includes('groq') ? 'bg-pink-100 text-pink-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {viewResponseModal.response.platform?.toLowerCase().includes('claude') ? 'Claude' :
                     viewResponseModal.response.platform?.toLowerCase().includes('chatgpt') || viewResponseModal.response.platform?.toLowerCase().includes('gpt') ? 'GPT' :
                     viewResponseModal.response.platform?.toLowerCase().includes('gemini') ? 'Gemini' :
                     viewResponseModal.response.platform?.toLowerCase().includes('perplexity') ? 'Perplexity' :
                     viewResponseModal.response.platform?.toLowerCase().includes('groq') ? 'Groq' :
                     viewResponseModal.response.platform || 'Unknown'}
                  </span>
                </div>
                <div className="text-sm font-medium text-gray-700 mb-2">Response:</div>
                <div className="text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 p-4 rounded max-h-80 overflow-y-auto">
                  {viewResponseModal.response.response}
                </div>
              </div>
            </div>
            <div className="p-6 border-t border-gray-200">
              <button
                onClick={() => setViewResponseModal(null)}
                className="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

  // Render Form View (existing form code)
  const steps = [
    { id: 1, title: "Brand Setup", description: "Basic brand information", icon: LayoutGrid },
    { id: 2, title: "Competitive Intelligence", description: "Competitors and keywords", icon: Target },
    { id: 3, title: "Platform Selection", description: "Choose AI platforms to monitor", icon: Settings },
    { id: 4, title: "Review & Launch", description: "Review settings and start analysis", icon: Play },
  ];

  return (
    <div className="min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8">
      <div className="max-w-6xl mx-auto mb-8">
        <div className="flex items-center justify-between mb-4">
          <button
            onClick={() => setViewMode('projects')}
            className="flex items-center gap-2 text-gray-600 hover:text-gray-900"
          >
            <ArrowLeft className="w-4 h-4" />
            Back to Projects
          </button>
        </div>
        {/* Progress Indicator */}
        <div className="flex items-center justify-between">
          {steps.map((step, index) => {
            const Icon = step.icon;
            const isActive = currentStep === step.id;
            const isCompleted = currentStep > step.id;
            
            return (
              <div key={step.id} className="flex items-center flex-1">
                <div className="flex flex-col items-center flex-1">
                  <div className={`w-12 h-12 rounded-full flex items-center justify-center mb-2 transition-all ${
                    isActive 
                      ? 'bg-purple-600 text-white' 
                      : isCompleted
                      ? 'bg-purple-400 text-white'
                      : 'bg-gray-300 text-gray-600'
                  }`}>
                    <Icon className="w-6 h-6" />
                  </div>
                  <div className="text-center">
                    <div className={`text-sm font-semibold mb-1 ${
                      isActive ? 'text-purple-600' : 'text-gray-600'
                    }`}>
                      {step.title}
                    </div>
                    <div className="text-xs text-gray-500">
                      {step.description}
                    </div>
                  </div>
                </div>
                {index < steps.length - 1 && (
                  <div className={`flex-1 h-0.5 mx-4 ${
                    isCompleted ? 'bg-purple-600' : 'bg-gray-300'
                  }`} />
                )}
              </div>
            );
          })}
        </div>
      </div>

      {/* Form Card */}
      <div className="max-w-2xl mx-auto">
        <div className="bg-gray-100 rounded-2xl p-8 shadow-xl">
          {/* Step 1: Brand Setup */}
          {currentStep === 1 && (
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-900 mb-2">
                  Brand Name *
                </label>
                <input
                  type="text"
                  value={brandName}
                  onChange={(e) => setBrandName(e.target.value)}
                  placeholder="Enter your brand name"
                  className="w-full px-4 py-3 bg-white text-gray-900 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-900 mb-2">
                  Website URL *
                </label>
                <input
                  type="text"
                  value={websiteUrl}
                  onChange={(e) => setWebsiteUrl(e.target.value)}
                  placeholder="example.com"
                  className="w-full px-4 py-3 bg-white text-gray-900 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-900 mb-2">
                  Industry *
                </label>
                <div className="relative">
                  <select
                    value={industry}
                    onChange={(e) => setIndustry(e.target.value)}
                    className="w-full px-4 py-3 bg-white text-gray-900 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent appearance-none pr-10"
                  >
                    {industries.map((ind) => (
                      <option key={ind} value={ind}>{ind}</option>
                    ))}
                  </select>
                  <ChevronDown className="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" />
                </div>
              </div>
            </div>
          )}

          {/* Step 2: Competitive Intelligence */}
          {currentStep === 2 && (
            <div className="space-y-6">
              {/* AI-Powered Suggestions */}
              <div className="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-xl p-6">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">
                      <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                      </svg>
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">âœ¨ AI-Powered Suggestions</h3>
                      <p className="text-sm text-gray-600">
                        {isGeneratingAI 
                          ? "Generating competitors and keywords..." 
                          : competitors.length > 0 || keywords.length > 0
                          ? "AI has generated suggestions below. Edit them or click Regenerate for new ones."
                          : "AI will generate competitors and keywords automatically. You can edit the results below."
                        }
                      </p>
                    </div>
                  </div>
                  <button
                    onClick={generateAISuggestions}
                    disabled={isGeneratingAI || !brandName.trim() || !websiteUrl.trim()}
                    className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:scale-105"
                  >
                    {isGeneratingAI ? (
                      <>
                        <RefreshCw className="w-4 h-4 animate-spin" />
                        Generating...
                      </>
                    ) : (
                      <>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        {competitors.length > 0 || keywords.length > 0 ? 'Regenerate' : 'Generate'}
                      </>
                    )}
                  </button>
                </div>
              </div>

              {/* Competitors (Optional) */}
              <div>
                <label className="block text-sm font-medium text-gray-900 mb-2">
                  Competitors
                </label>
                <div className="flex gap-2 mb-3">
                  <input
                    type="text"
                    value={newCompetitor}
                    onChange={(e) => setNewCompetitor(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && addCompetitor()}
                    placeholder="Add competitor name"
                    className="flex-1 px-4 py-3 bg-white text-gray-900 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  />
                  <button
                    onClick={addCompetitor}
                    className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                  >
                    Add
                  </button>
                </div>
                {competitors.length > 0 && (
                  <div className="flex flex-wrap gap-2">
                    {competitors.map((competitor) => (
                      <span
                        key={competitor}
                        className="px-3 py-1 bg-gray-200 text-gray-900 rounded-lg flex items-center gap-2"
                      >
                        {competitor}
                        <button
                          onClick={() => setCompetitors(competitors.filter(c => c !== competitor))}
                          className="text-gray-400 hover:text-white"
                        >
                          Ã—
                        </button>
                      </span>
                    ))}
                  </div>
                )}
              </div>
              
              {/* Target Keywords */}
              <div>
                <label className="block text-sm font-medium text-gray-900 mb-2">
                  Target Keywords
                </label>
                <div className="flex gap-2 mb-3">
                  <input
                    type="text"
                    value={newKeyword}
                    onChange={(e) => setNewKeyword(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && addKeyword()}
                    placeholder="Add keyword"
                    className="flex-1 px-4 py-3 bg-white text-gray-900 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  />
                  <button
                    onClick={addKeyword}
                    className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                  >
                    Add
                  </button>
                </div>
                {keywords.length > 0 && (
                  <div className="flex flex-wrap gap-2">
                    {keywords.map((keyword) => (
                      <span
                        key={keyword}
                        className="px-3 py-1 bg-gray-200 text-gray-900 rounded-lg flex items-center gap-2"
                      >
                        {keyword}
                        <button
                          onClick={() => setKeywords(keywords.filter(k => k !== keyword))}
                          className="text-gray-400 hover:text-white"
                        >
                          Ã—
                        </button>
                      </span>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Step 3: Platform Selection */}
          {currentStep === 3 && (
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-900 mb-4">
                  Select AI Platforms
                </label>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  {platformOptions.map((platform) => (
                    <label
                      key={platform.id}
                      className={`flex items-center gap-3 p-4 border-2 rounded-lg cursor-pointer transition-all ${
                        selectedPlatforms.includes(platform.id)
                          ? "border-purple-600 bg-purple-50"
                          : "border-gray-300 bg-white hover:border-gray-400"
                      }`}
                    >
                      <input
                        type="checkbox"
                        checked={selectedPlatforms.includes(platform.id)}
                        onChange={() => {
                          if (selectedPlatforms.includes(platform.id)) {
                            setSelectedPlatforms(selectedPlatforms.filter(p => p !== platform.id));
                          } else {
                            setSelectedPlatforms([...selectedPlatforms, platform.id]);
                          }
                        }}
                        className="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                      />
                      {platform.icon ? (
                        <Image 
                          src={platform.icon} 
                          alt={platform.name} 
                          width={platform.id === 'gemini' ? 40 : 24} 
                          height={platform.id === 'gemini' ? 40 : 24} 
                          className={`${platform.id === 'gemini' ? 'w-10 h-10' : 'w-6 h-6'} object-contain ${platform.id === 'gemini' ? 'brightness-110 contrast-110' : ''}`}
                          quality={platform.id === 'gemini' ? 100 : 75}
                          unoptimized={platform.id === 'gemini'}
                        />
                      ) : null}
                      <span className={`font-medium ${
                        selectedPlatforms.includes(platform.id) ? "text-purple-900" : "text-gray-900"
                      }`}>
                        {platform.name}
                      </span>
                    </label>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Step 4: Review & Launch */}
          {currentStep === 4 && (
            <div className="space-y-6">
              <div className="bg-white rounded-lg p-6 space-y-4">
                <h3 className="text-lg font-semibold text-gray-900 mb-4">Review Your Settings</h3>
                <div>
                  <span className="text-sm font-medium text-gray-600">Brand Name:</span>
                  <p className="text-gray-900">{brandName || "Not set"}</p>
                </div>
                <div>
                  <span className="text-sm font-medium text-gray-600">Website URL:</span>
                  <p className="text-gray-900">{websiteUrl || "Not set"}</p>
                </div>
                <div>
                  <span className="text-sm font-medium text-gray-600">Industry:</span>
                  <p className="text-gray-900">{industry}</p>
                </div>
                <div>
                  <span className="text-sm font-medium text-gray-600">Competitors:</span>
                  <p className="text-gray-900">{competitors.length > 0 ? competitors.join(", ") : "None"}</p>
                </div>
                <div>
                  <span className="text-sm font-medium text-gray-600">Keywords:</span>
                  <p className="text-gray-900">{keywords.length > 0 ? keywords.join(", ") : "None"}</p>
                </div>
                <div>
                  <span className="text-sm font-medium text-gray-600">Platforms:</span>
                  <p className="text-gray-900">{selectedPlatforms.map(p => platformOptions.find(opt => opt.id === p)?.name).join(", ")}</p>
                </div>
              </div>

              {/* Google Search Console Option */}
              <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl p-6">
                <div className="flex items-start gap-4">
                  <input
                    type="checkbox"
                    id="fetchGSC"
                    checked={fetchGSCKeywords}
                    onChange={(e) => setFetchGSCKeywords(e.target.checked)}
                    className="mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                  />
                  <div className="flex-1">
                    <label htmlFor="fetchGSC" className="block text-base font-semibold text-gray-900 mb-2 cursor-pointer">
                      ðŸ” Fetch Keywords from Google Search Console
                    </label>
                    <p className="text-sm text-gray-600 mb-2">
                      If you've connected Google Search Console, enable this to automatically fetch real keywords your website ranks for. These will be combined with your manual keywords for more accurate brand analysis.
                    </p>
                    <p className="text-xs text-gray-500">
                      {fetchGSCKeywords 
                        ? "âœ… GSC keywords will be fetched during launch (if connected)" 
                        : "âšª Only website crawling and manual keywords will be used"
                      }
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Navigation Buttons */}
          <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-300">
            <button
              onClick={() => setViewMode('projects')}
              className="flex items-center gap-2 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
            >
              <ArrowLeft className="w-5 h-5" />
              Cancel
            </button>
            
            <div className="flex gap-3">
              {currentStep > 1 && (
                <button
                  onClick={handleBack}
                  className="flex items-center gap-2 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                >
                  <ArrowLeft className="w-5 h-5" />
                  Back
                </button>
              )}
              
              {currentStep < totalSteps ? (
                <button
                  onClick={handleNext}
                  disabled={isGeneratingAI && currentStep === 1}
                  className="flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {isGeneratingAI && currentStep === 1 ? (
                    <>
                      <RefreshCw className="w-5 h-5 animate-spin" />
                      Generating AI Suggestions...
                    </>
                  ) : (
                    <>
                      Next
                      <ArrowRight className="w-5 h-5" />
                    </>
                  )}
                </button>
              ) : (
                <button
                  onClick={handleAnalyze}
                  disabled={isAnalyzing}
                  className="flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {isAnalyzing ? "Launching..." : "Launch Analysis"}
                  <Play className="w-5 h-5" />
                </button>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* View Response Modal - Simple fixed modal */}
      {viewResponseModal?.open && viewResponseModal?.response && (
        <div 
          className="fixed inset-0 flex items-center justify-center p-4"
          style={{ 
            zIndex: 99999,
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)'
          }}
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              setViewResponseModal(null);
            }
          }}
        >
          <div 
            className="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] flex flex-col shadow-2xl"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between p-6 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-900">Full Response</h3>
              <button
                onClick={() => setViewResponseModal(null)}
                className="text-gray-400 hover:text-gray-600 transition-colors"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            <div className="p-6 overflow-y-auto flex-1">
              <div className="mb-4">
                <div className="text-sm font-medium text-gray-700 mb-2">Query:</div>
                <div className="text-sm text-gray-900 bg-gray-50 p-3 rounded">
                  {viewResponseModal.prompt}
                </div>
              </div>
              <div className="mb-4">
                <div className="flex items-center gap-2 mb-2">
                  <span className={`px-3 py-1 rounded text-sm font-medium capitalize ${
                    viewResponseModal.response.platform?.toLowerCase().includes('claude') ? 'bg-orange-100 text-orange-800' :
                    viewResponseModal.response.platform?.toLowerCase().includes('chatgpt') || viewResponseModal.response.platform?.toLowerCase().includes('gpt') ? 'bg-green-100 text-green-800' :
                    viewResponseModal.response.platform?.toLowerCase().includes('gemini') ? 'bg-blue-100 text-blue-800' :
                    viewResponseModal.response.platform?.toLowerCase().includes('perplexity') ? 'bg-purple-100 text-purple-800' :
                    viewResponseModal.response.platform?.toLowerCase().includes('groq') ? 'bg-pink-100 text-pink-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {viewResponseModal.response.platform?.toLowerCase().includes('claude') ? 'Claude' :
                     viewResponseModal.response.platform?.toLowerCase().includes('chatgpt') || viewResponseModal.response.platform?.toLowerCase().includes('gpt') ? 'GPT' :
                     viewResponseModal.response.platform?.toLowerCase().includes('gemini') ? 'Gemini' :
                     viewResponseModal.response.platform?.toLowerCase().includes('perplexity') ? 'Perplexity' :
                     viewResponseModal.response.platform?.toLowerCase().includes('groq') ? 'Groq' :
                     viewResponseModal.response.platform || 'Unknown'}
                  </span>
                </div>
                <div className="text-sm font-medium text-gray-700 mb-2">Response:</div>
                <div className="text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 p-4 rounded max-h-80 overflow-y-auto">
                  {viewResponseModal.response.response}
                </div>
              </div>
            </div>
            <div className="p-6 border-t border-gray-200">
              <button
                onClick={() => setViewResponseModal(null)}
                className="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Keywords Tab Component
function KeywordsTab({ selectedProject }: { selectedProject: Project }) {
  const [gscKeywords, setGscKeywords] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (selectedProject?.id) {
      fetchGSCKeywords();
    }
  }, [selectedProject]);

  const fetchGSCKeywords = async () => {
    try {
      setLoading(true);
      const response = await fetch(`/api/brand-analysis/${selectedProject.id}/gsc-keywords`);
      const data = await response.json();
      
      if (data.success) {
        setGscKeywords(data.keywords || []);
      }
    } catch (error) {
      console.error('Error fetching GSC keywords:', error);
    } finally {
      setLoading(false);
    }
  };

  // Get manual keywords (target_keywords or keywords field)
  const manualKeywords = selectedProject.keywords || [];

  // Calculate GSC summary stats
  const totalClicks = gscKeywords.reduce((sum, kw) => sum + kw.clicks, 0);
  const totalImpressions = gscKeywords.reduce((sum, kw) => sum + kw.impressions, 0);
  const avgCTR = gscKeywords.length > 0
    ? (gscKeywords.reduce((sum, kw) => sum + kw.ctr, 0) / gscKeywords.length * 100).toFixed(2)
    : 0;

  const totalKeywords = manualKeywords.length + gscKeywords.length;

  return (
    <div className="space-y-6">
      {/* Page Header */}
      <div>
        <h3 className="text-lg font-semibold text-gray-900 mb-2">
          Keywords Used in Analysis
        </h3>
        <p className="text-sm text-gray-600 mb-4">
          Total: {totalKeywords} keywords ({manualKeywords.length} manual + {gscKeywords.length} from GSC)
        </p>
      </div>

      {/* Manual Keywords Section */}
      <div className="bg-white border border-gray-200 rounded-lg p-6">
        <div className="flex items-center gap-2 mb-4">
          <div className="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
            <FileText className="w-4 h-4 text-purple-600" />
          </div>
          <div>
            <h4 className="text-md font-semibold text-gray-900">ðŸ’¡ Manual Keywords</h4>
            <p className="text-xs text-gray-500">Keywords entered during project creation</p>
          </div>
        </div>

        {manualKeywords.length > 0 ? (
          <div className="space-y-3">
            <div className="flex flex-wrap gap-2">
              {manualKeywords.map((keyword, idx) => (
                <div
                  key={idx}
                  className="px-4 py-2 bg-purple-50 border border-purple-200 rounded-lg text-sm font-medium text-purple-900"
                >
                  {keyword}
                </div>
              ))}
            </div>
            <p className="text-xs text-gray-500 mt-3">
              Total: {manualKeywords.length} keyword{manualKeywords.length !== 1 ? 's' : ''}
            </p>
          </div>
        ) : (
          <div className="text-center py-8 text-gray-500">
            <p className="text-sm">No manual keywords provided</p>
          </div>
        )}
      </div>

      {/* Google Search Console Section */}
      <div className="bg-white border border-gray-200 rounded-lg p-6">
        <div className="flex items-center gap-2 mb-4">
          <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
            <Search className="w-4 h-4 text-blue-600" />
          </div>
          <div>
            <h4 className="text-md font-semibold text-gray-900">ðŸ” Google Search Console</h4>
            <p className="text-xs text-gray-500">Keywords from your verified website</p>
          </div>
        </div>

        {loading ? (
          <div className="flex items-center justify-center py-8">
            <RefreshCw className="w-6 h-6 animate-spin text-blue-600" />
            <span className="ml-3 text-gray-600 text-sm">Loading GSC keywords...</span>
          </div>
        ) : gscKeywords.length > 0 ? (
          <div className="space-y-6">

            {/* Summary Stats */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-blue-900">Total Keywords</span>
                  <Search className="w-4 h-4 text-blue-600" />
                </div>
                <div className="text-2xl font-bold text-blue-900">{gscKeywords.length}</div>
              </div>

              <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-green-900">Total Clicks</span>
                  <TrendingUp className="w-4 h-4 text-green-600" />
                </div>
                <div className="text-2xl font-bold text-green-900">{totalClicks.toLocaleString()}</div>
              </div>

              <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-purple-900">Total Impressions</span>
                  <Eye className="w-4 h-4 text-purple-600" />
                </div>
                <div className="text-2xl font-bold text-purple-900">{totalImpressions.toLocaleString()}</div>
              </div>
            </div>

            {/* Keywords Table */}
            <div className="border border-gray-200 rounded-lg overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50 border-b border-gray-200">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Keyword
                      </th>
                      <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <div className="flex items-center justify-center gap-1">
                          <TrendingUp className="w-3 h-3" />
                          Position
                        </div>
                      </th>
                      <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <div className="flex items-center justify-center gap-1">
                          <TrendingUp className="w-3 h-3" />
                          Clicks
                        </div>
                      </th>
                      <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <div className="flex items-center justify-center gap-1">
                          <Eye className="w-3 h-3" />
                          Impressions
                        </div>
                      </th>
                      <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        CTR
                      </th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {gscKeywords.map((keyword, idx) => (
                      <tr key={idx} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm font-medium text-gray-900">{keyword.keyword}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-center">
                          <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            keyword.position <= 3 
                              ? 'bg-green-100 text-green-800' 
                              : keyword.position <= 10 
                              ? 'bg-blue-100 text-blue-800' 
                              : 'bg-gray-100 text-gray-800'
                          }`}>
                            {keyword.position}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900">
                          {keyword.clicks.toLocaleString()}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900">
                          {keyword.impressions.toLocaleString()}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900">
                          {(keyword.ctr * 100).toFixed(2)}%
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {selectedProject.last_gsc_sync && (
              <p className="text-xs text-gray-500 mt-4">
                Last synced: {new Date(selectedProject.last_gsc_sync).toLocaleString()}
              </p>
            )}
          </div>
        ) : (
          <div className="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <Search className="w-8 h-8 text-gray-400" />
            </div>
            <h4 className="text-md font-semibold text-gray-900 mb-2">
              Google Search Console Not Connected
            </h4>
            <p className="text-sm text-gray-600 mb-4 max-w-md mx-auto">
              Connect your Google Search Console in Settings to automatically fetch keywords 
              from your verified websites during analysis.
            </p>
            <button
              onClick={() => window.location.href = '/dashboard/settings'}
              className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
            >
              <Settings className="w-4 h-4" />
              Go to Settings
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
